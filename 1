# Build stage
FROM scratch AS builder

# Define build arguments for proxy settings
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

# Set environment variables to bypass proxy if build args are not provided
ENV HTTP_PROXY=${HTTP_PROXY:-}
ENV HTTPS_PROXY=${HTTPS_PROXY:-}
ENV NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}

# Copy pre-built Go binaries for both architectures
COPY main-amd64 /main-amd64
COPY main-arm64 /main-arm64

# Final stage
FROM scratch

# Define build arguments for proxy settings (needed again for multi-stage build)
ARG HTTP_PROXY
ARG HTTPS_PROXY
ARG NO_PROXY

# Set environment variables to bypass proxy if build args are not provided
ENV HTTP_PROXY=${HTTP_PROXY:-}
ENV HTTPS_PROXY=${HTTPS_PROXY:-}
ENV NO_PROXY=${NO_PROXY:-localhost,127.0.0.1}

# Copy the appropriate binary from the builder stage based on the target architecture
ARG TARGETARCH
COPY --from=builder /main-${TARGETARCH} /main

# Copy the index.html file
COPY index.html /index.html

# Expose port 8080 to the outside world
EXPOSE 8080

# Command to run the executable
CMD ["/main"]

